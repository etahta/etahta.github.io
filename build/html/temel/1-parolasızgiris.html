<!DOCTYPE html>

<html lang="tr" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>initramfs &#8212; etahta Wiki  belgelendirmesi</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=38388ced" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=86603d0e" />
    <script src="../_static/documentation_options.js?v=622dbbea"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/translations.js?v=34f4c3a9"></script>
    <link rel="canonical" href="https://etahta.github.io/devel/doc/wiki/temel/1-parolasızgiris.html" />
    <link rel="index" title="Dizin" href="../genindex.html" />
    <link rel="search" title="Ara" href="../search.html" />
    <link rel="next" title="busybox Nedir?" href="2-cozunurlukayarlama.html" />
    <link rel="prev" title="Etahta Ayarları" href="index.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="initramfs">
<h1>initramfs<a class="headerlink" href="#initramfs" title="Link to this heading">¶</a></h1>
<p>initramfs dosyası kernel ile birlikte kullanılan belleğe ilk yüklenen dosyadır. Bu dosyanın görevi sistemin kurulu olduğu diski tanımak için gereken modülleri yüklemek ve sistemi başlatmaktır. Bu dosya <strong>/boot/initrd.img-xxx</strong> konumunda yer alır.
initramfs dosyası üretmek için öncelikle bir dizin oluşturulur. Paketlenen dosya gzip veya lzma ile sıkmıştırılabilir veya sıkıştırılmadan da kullanılabilir.  Bu dizine gerekli dosyalar eklenir ve aşağıdaki gibi paketlenir.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>/initrd/dizini/
find<span class="w"> </span>.<span class="w"> </span><span class="p">|</span><span class="w"> </span>cpio<span class="w"> </span>-o<span class="w"> </span>-H<span class="w"> </span>newc<span class="w"> </span><span class="p">|</span><span class="w"> </span>gzip<span class="w"> </span>-9<span class="w"> </span>&gt;<span class="w"> </span>/boot/initrd.img-xxx
</pre></div>
</div>
<p>Kernel initrd dosyasını ram üzerine yükler ve içerisindeki /init dosyasını çalıştırır.</p>
<p>Örneğin aşağıdaki gibi bir C dosyamız olsun.</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(){</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello World!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// programın bitmesini engellemek için</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Bu dosyayı static olarak derleyelim ve initramfs dosyasının içine koyup paketleyelim.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>/tmp/initrd
<span class="nb">cd</span><span class="w"> </span>/tmp/initrd
gcc<span class="w"> </span>-o<span class="w"> </span>/home/deneme/main.c<span class="w"> </span>/tmp/initrd/init<span class="w"> </span>-static
find<span class="w"> </span>.<span class="w"> </span><span class="p">|</span><span class="w"> </span>cpio<span class="w"> </span>-o<span class="w"> </span>-H<span class="w"> </span>newc<span class="w"> </span>&gt;<span class="w"> </span>/home/deneme/initrd.img
</pre></div>
</div>
<p>Daha sonra da qemu kullanarak test edelim.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>qemu-system-x86_86<span class="w"> </span>--enable-kvm<span class="w"> </span>-kernel<span class="w"> </span>/boot/vmlinuz-5.17<span class="w"> </span>-initrd<span class="w"> </span>/home/deneme/initrd.img<span class="w"> </span>-append<span class="w"> </span><span class="s2">&quot;quiet&quot;</span><span class="w"> </span>-m<span class="w"> </span>512m
</pre></div>
</div>
<p>Eğer tüm adımları doğru yaptıysanız ekranda hello world yazısı ile karşılaşacaksınız. Ayrıca kendi işletim sisteminizi çalıştırmış olacaksınız.</p>
<p>Teorik olarak kernel ve initramfs tek başına bir işletim sistemi sayılabilir. Genel olarak linux dağıtımlarında sistemin kurulu olduğu diskte GNU sistemi bulunur ve kernel ve initramfs kullanılarak bu sistemdeki <strong>/sbin/init</strong> dosyası çalıştırılır. Bu dosya servis yöneticisi dosyamızdır ve sistemin geri kalanının çalışmasını sağlar.</p>
<p>Yukarıdaki anlatımda initramfs nasıl çalıştığından söz edildi. Şimdi ise bir linux dağıtımında kullanılması için gereken işlemler üzerinde durulacaktır. Öncelikle initramfs oluşturma dizinimize gereken modülleri eklemeliniz. Bunun için /lib/modules/xxx içerisindeki dosyaları initramfs içine kopyalayalım.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>...
mkdir<span class="w"> </span>-p<span class="w"> </span>/tmp/initrd/lib/modules/
<span class="k">for</span><span class="w"> </span>directory<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">{</span>crypto,fs,lib<span class="o">}</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>drivers/<span class="o">{</span>block,ata,md,firewire<span class="o">}</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>drivers/<span class="o">{</span>scsi,message,pcmcia,virtio<span class="o">}</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>drivers/usb/<span class="o">{</span>host,storage<span class="o">}</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>find<span class="w"> </span>/lib/modules/<span class="k">$(</span>uname<span class="w"> </span>-r<span class="k">)</span>/kernel/<span class="si">${</span><span class="nv">directory</span><span class="si">}</span>/<span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-exec<span class="w"> </span>install<span class="w"> </span><span class="o">{}</span><span class="w"> </span>/tmp/initrd/lib/modules/<span class="k">$(</span>uname<span class="w"> </span>-r<span class="k">)</span>/<span class="w"> </span><span class="se">\;</span>
<span class="k">done</span>
depmod<span class="w"> </span>--all<span class="w"> </span>--basedir<span class="o">=</span>/tmp/initrd
...
</pre></div>
</div>
<p>Yukarıdaki örnekte ilk önce gerekli modülleri kopyaladık ve ardından modüllerin listesini güncellemek için <strong>depmod</strong> komutunu kullandık. Bu modülleri yüklemek için /init dosyamız içinde <strong>modprobe</strong> komutunu kullanabiliriz. Bu dosya genellikle <strong>busybox ash</strong> kullanılarak yazılır. Bunun için öncelikle busybox dosyamız initramfs dizinine kopyalanır. Ve ardından sembolik bağları atılarak komutları kullanılabilir hale getirilir.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>...
mkdir<span class="w"> </span>-p<span class="w"> </span>/tmp/initrd/bin
install<span class="w"> </span>/bin/busybox<span class="w"> </span>/tmp/initrd/busybox
chroot<span class="w"> </span>/tmp/initrd<span class="w"> </span>/busybox<span class="w"> </span>--install<span class="w"> </span>-s<span class="w"> </span>/bin
...
</pre></div>
</div>
<p>Burada eğer busybox static olarak derlenmemişse çalışmayacağı için <strong>glibc</strong> ve gereken diğer dosyalarımızı da eklememiz gerekmektedir. Bunun için önce <strong>ldd</strong> komutu ile bağımlılıkları öğrenilir ve bağımlılık dosyası initramfs dizininde /lib içine yerleştirilir. Bu işlem tüm alt bağımlılıklarda tekrarlarır. Aşağıdaki örnekte bağımlılıkların bulunması ve kopyalanması için bir fonksiyon oluşturulmuştur.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>...
<span class="k">function</span><span class="w"> </span>get_lib<span class="o">(){</span>
<span class="w">    </span>ldd<span class="w"> </span><span class="nv">$1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f3<span class="w"> </span>-d<span class="s2">&quot; &quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>lib<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$lib</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span>:<span class="w"> </span>empty<span class="w"> </span>line
<span class="w">        </span><span class="k">elif</span><span class="w"> </span>!<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="si">${</span><span class="nv">libs</span><span class="p">[@]</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="nv">$lib</span><span class="w"> </span>&gt;/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$lib</span>
<span class="w">            </span>get_lib<span class="w"> </span><span class="nv">$lib</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">done</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span><span class="p">|</span><span class="w"> </span>uniq
<span class="o">}</span>
<span class="k">function</span><span class="w"> </span>install_binary<span class="o">(){</span>
<span class="w">    </span>get_lib<span class="w"> </span><span class="nv">$1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>lib<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="nv">file</span><span class="o">=</span>/tmp/initrd/lib/<span class="k">$(</span>basename<span class="w"> </span><span class="nv">$lib</span><span class="k">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="nv">$file</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span>install<span class="w"> </span><span class="nv">$lib</span><span class="w"> </span><span class="nv">$file</span>
<span class="w">        </span><span class="k">fi</span>
<span class="w">    </span><span class="k">done</span>
<span class="w">    </span>install<span class="w"> </span><span class="nv">$1</span><span class="w"> </span>/tmp/initrd/bin/<span class="k">$(</span>basename<span class="w"> </span><span class="nv">$1</span><span class="k">)</span>
<span class="o">}</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>/tmp/initrd/lib/
ln<span class="w"> </span>-s<span class="w"> </span>lib<span class="w"> </span>/tmp/initrd/lib64
install_binary<span class="w"> </span>/bin/busybox
...
</pre></div>
</div>
<p>Eğer Bazı dağıtımlarda /lib64 bulunur. Bu sebeple lib64 adında bir sembolik bağ oluşturmamız gerekebilir.</p>
<p>Modülleri yüklemek için elle <strong>modprobe</strong> komutu kullanılabilir. Bu sayede initramfs dosyamıza eklediğimiz modüllerin tamamını yükleyip donanımları tanıması sağlanabilir.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>...
find<span class="w"> </span>/lib/modules/<span class="k">$(</span>uname<span class="w"> </span>-r<span class="k">)</span>/<span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>module<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nv">module_name</span><span class="o">=</span><span class="k">$(</span>basename<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$module</span><span class="s2">&quot;</span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s2">&quot;s/\..*//g&quot;</span><span class="k">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="si">${</span><span class="nv">module_name</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;debug&quot;</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>:<span class="w"> </span>ignore<span class="w"> </span>debug<span class="w"> </span>module
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span>modprobe<span class="w"> </span><span class="si">${</span><span class="nv">module_name</span><span class="si">}</span>
<span class="w">    </span><span class="k">fi</span>
<span class="k">done</span>
...
</pre></div>
</div>
<p>Bu işlemin dezavantajı hem yavaş çalışması hem de gerekli olmayan modüllerin de yüklenmesidir. Bu yüzden bu yöntem yerine alternatif olarak <strong>eudev</strong> veya <strong>systemd-udev</strong> kullanılabilir. Bunun için initramfs dizinimize aşağıdaki eklemeler yapılır.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>...
<span class="c1"># eudev için</span>
install_binary<span class="w"> </span>/sbin/udevd
<span class="c1"># systemd-udev için</span>
install_binary<span class="w"> </span>/lib/systemd/systemd-udevd
<span class="c1"># Her ikisi için</span>
install_binary<span class="w"> </span>/sbin/udevadm
...
</pre></div>
</div>
<p>Daha sonra initramfs içerisindeki /init içinde aşağıdaki komutlar çalıştırılmalıdır.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>...
<span class="c1"># systemd-udev için</span>
systemd-udevd<span class="w"> </span>--daemon
<span class="c1"># eudev için</span>
udevd<span class="w"> </span>--daemon
<span class="c1"># Her ikisi için</span>
udevadm<span class="w"> </span>trigger<span class="w"> </span>-c<span class="w"> </span>add
udevadm<span class="w"> </span>settle
...
</pre></div>
</div>
<p>Eğer systemd kullanmayan bir dağıtım geliştirecekseniz veya initramfs dosyasının daha az boyutlu olmasını istiyorsanız <strong>eudev</strong> tercih etmelisiniz.</p>
<p>Initramfs dosyasının birinci amacı ana sistemi diske bağlayıp görevi servis yöneticisine devretmektir. Bu sebeple önce disk bağlanır ve ardından içerisine <strong>/dev</strong>, <strong>/sys</strong>, <strong>/proc</strong> dizinleri bağlanır ve <strong>switch_root</strong> kullanılarak ana sisteme geçilir.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Eğer yoksa dev sys proc dizinlerini oluşturalım.</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>/dev<span class="w"> </span>/sys<span class="w"> </span>/proc
<span class="c1"># dev sys proc bağlayalım</span>
mount<span class="w"> </span>-t<span class="w"> </span>devtmpfs<span class="w"> </span>devtmpfs<span class="w"> </span>/dev
mount<span class="w"> </span>-t<span class="w"> </span>sysfs<span class="w"> </span>sysfs<span class="w"> </span>/sys
mount<span class="w"> </span>-t<span class="w"> </span>proc<span class="w"> </span>proc<span class="w"> </span>/proc
...
<span class="c1"># diski bağlayalım</span>
mount<span class="w"> </span><span class="nv">$root</span><span class="w"> </span>/new_root
<span class="c1"># dev sys proc taşıyalım</span>
mount<span class="w"> </span>--move<span class="w"> </span>/dev<span class="w"> </span>/new_root/dev
mount<span class="w"> </span>--move<span class="w"> </span>/sys<span class="w"> </span>/new_root/sys
mount<span class="w"> </span>--move<span class="w"> </span>/proc<span class="w"> </span>/new_root/proc
<span class="c1"># /dev/root oluşturalım (isteğe bağlı)</span>
ln<span class="w"> </span>-s<span class="w"> </span><span class="nv">$root</span><span class="w"> </span>/new_root/dev/root
<span class="c1"># servis yöneticisini çalıştıralım.</span>
<span class="nb">exec</span><span class="w"> </span>switch_root<span class="w"> </span>/new_root<span class="w"> </span><span class="nv">$init</span>
</pre></div>
</div>
<p>Yukarıdaki örnekte <strong>$root</strong> ve <strong>$init</strong> değişkenleri değerini /proc/cmdline içerisinden okumalısınız. varsayılan init değeri <strong>/sbin/init</strong> olmalıdır.</p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/logo.svg" alt="Logo"/>
    
  </a>
</p>








<h3>Gezinti</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../giris/index.html">Giriş Seçenekleri</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Etahta Ayarları</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">initramfs</a></li>
<li class="toctree-l2"><a class="reference internal" href="2-cozunurlukayarlama.html">busybox Nedir?</a></li>
<li class="toctree-l2"><a class="reference internal" href="3-sesayarlama.html">kmod Nedir? Nasıl Yazılır ve Kullanılır?</a></li>
<li class="toctree-l2"><a class="reference internal" href="3-sesayarlama.html#hello-c-dosyamiz">hello.c dosyamız</a></li>
<li class="toctree-l2"><a class="reference internal" href="3-sesayarlama.html#makefile-dosyamiz">Makefile dosyamız</a></li>
<li class="toctree-l2"><a class="reference internal" href="3-sesayarlama.html#modulun-derlenmesi-ve-eklenip-kaldirilmasi">modülün derlenmesi ve eklenip kaldırılması</a></li>
<li class="toctree-l2"><a class="reference internal" href="3-sesayarlama.html#not">Not:</a></li>
<li class="toctree-l2"><a class="reference internal" href="4-kisayololusturma.html">udev Nedir? Niçin Kullanılır?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../wine/index.html">Wine Ayarları</a></li>
<li class="toctree-l1"><a class="reference internal" href="../yazici/index.html">Yazıcı Ayarları</a></li>
</ul>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;etahta 2023.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../_sources/temel/1-parolasızgiris.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>